generator client {
  provider = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

enum InterviewStatus {
  created
  used
  recording
  ending
  completed
  failed
}

enum InterviewDecision {
  undecided
  pass
  fail
  hold
}

enum ChatRole {
  interviewer
  candidate
}

enum OrgPlan {
  starter
}

model Application {
  applicationId String   @id
  orgId         String?
  candidateName String?
  candidateEmail String?
  applicationNotes String? @db.Text
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  interviews    Interview[]

  @@index([orgId])
}

model Interview {
  interviewId       String          @id
  publicToken       String?         @unique
  orgId             String?
  applicationId     String
  roomName          String          @unique
  status            InterviewStatus @default(created)
  decision          InterviewDecision @default(undecided)
  round             Int             @default(1)
  durationSec       Int
  quotaReservedSec  Int?
  actualDurationSec Int?

  candidateIdentity String
  agentName         String

  dispatchId        String?
  streamUid         String?
  recordingStartedAt DateTime?
  interviewPrompt   String?         @db.Text
  expiresAt         DateTime?
  quotaSettledAt    DateTime?

  createdAt         DateTime        @default(now())
  usedAt            DateTime?
  candidateJoinedAt DateTime?
  endedAt           DateTime?
  error             String?

  messages          InterviewMessage[]
  application       Application @relation(fields: [applicationId], references: [applicationId], onDelete: Cascade)

  @@index([orgId])
  @@index([applicationId])
}

model InterviewMessage {
  messageId   String    @id
  interviewId String
  orgId       String?
  role        ChatRole
  text        String
  offsetMs    Int
  createdAt   DateTime  @default(now())

  interview   Interview @relation(fields: [interviewId], references: [interviewId], onDelete: Cascade)

  @@index([interviewId])
  @@index([orgId])
  @@index([interviewId, offsetMs])
}

model PromptTemplate {
  templateId String   @id
  orgId      String
  name       String
  body       String   @db.Text
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([orgId])
  @@unique([orgId, name])
}

model OrgSetting {
  orgId               String   @id
  defaultDurationMin  Int      @default(10)
  defaultExpiresWeeks Int      @default(1)
  defaultExpiresDays  Int      @default(0)
  defaultExpiresHours Int      @default(0)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model OrgSubscription {
  orgId           String   @id
  plan            OrgPlan
  billingAnchorAt DateTime
  cycleStartedAt  DateTime
  cycleEndsAt     DateTime
  usedSec         Int      @default(0)
  reservedSec     Int      @default(0)
  overageApproved Boolean  @default(false)
  renewOnCycleEnd Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}
