generator client {
  provider = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

enum InterviewStatus {
  created
  used
  recording
  ending
  completed
  failed
}

enum InterviewDecision {
  undecided
  pass
  fail
  hold
}

enum ChatRole {
  interviewer
  candidate
}

model Application {
  applicationId String   @id
  orgId         String?
  candidateName String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  interviews    Interview[]

  @@index([orgId])
}

model Interview {
  interviewId       String          @id
  publicToken       String?         @unique
  orgId             String?
  applicationId     String
  roomName          String          @unique
  status            InterviewStatus @default(created)
  decision          InterviewDecision @default(undecided)
  round             Int             @default(1)
  durationSec       Int

  candidateIdentity String
  agentName         String

  dispatchId        String?
  egressId          String?

  r2Bucket          String
  r2ObjectKey       String?
  recordingStartedAt DateTime?
  interviewPrompt   String?         @db.Text
  interviewNotes    String?         @db.Text
  expiresAt         DateTime?

  createdAt         DateTime        @default(now())
  usedAt            DateTime?
  candidateJoinedAt DateTime?
  endedAt           DateTime?
  error             String?

  messages          InterviewMessage[]
  application       Application @relation(fields: [applicationId], references: [applicationId], onDelete: Cascade)

  @@index([orgId])
  @@index([applicationId])
}

model InterviewMessage {
  messageId   String    @id
  interviewId String
  orgId       String?
  role        ChatRole
  text        String
  offsetMs    Int
  createdAt   DateTime  @default(now())

  interview   Interview @relation(fields: [interviewId], references: [interviewId], onDelete: Cascade)

  @@index([interviewId])
  @@index([orgId])
  @@index([interviewId, offsetMs])
}

model PromptTemplate {
  templateId String   @id
  orgId      String
  name       String
  body       String   @db.Text
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([orgId])
  @@unique([orgId, name])
}
